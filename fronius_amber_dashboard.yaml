# ============================================================================
# FRONIUS SOLAR CURTAILMENT DASHBOARD
# ============================================================================
# Copy this entire section and paste into a new dashboard view
# Replace all placeholder entities (marked with # CHANGE THIS) with your actual entity IDs

views:
  - title: Solar Curtailment Monitor
    icon: mdi:solar-power-variant
    cards:
      # === MANUAL CONTROLS ===
      - type: entities
        title: ðŸŽ›ï¸ Manual Controls
        entities:
          - entity: input_boolean.fronius_manual_override
            name: ðŸš¨ EMERGENCY OVERRIDE
            secondary_info: last-changed
          - type: divider
          - entity: input_boolean.solar_curtailment_active
            name: Curtailment Status
            secondary_info: last-changed
        state_color: true
        show_header_toggle: false

      # === INSTRUCTIONS ===
      - type: markdown
        title: âš ï¸ Emergency Override Instructions
        content: |-
          **Turn ON Emergency Override to:**
          â€¢ Immediately restore Fronius to full power
          â€¢ Block all automatic curtailment
          â€¢ Use if automation misbehaves or you need full solar
          
          **Remember:** Turn OFF when issue is resolved!
          Override automatically resets at 6am each day.

      # === CURRENT STATUS ===
      - type: entities
        title: ðŸ“Š Current System Status
        entities:
          - entity: sensor.amber_general_price  # CHANGE THIS to your Amber price sensor
            name: Grid Sell Price
            icon: mdi:currency-usd
          - entity: sensor.inverter_pv_power  # CHANGE THIS to your solar power sensor
            name: Solar Generation
            icon: mdi:solar-power
          - entity: sensor.inverter_load_power  # CHANGE THIS to your house load sensor
            name: House Load
            icon: mdi:home-lightning-bolt
          - entity: sensor.inverter_battery_level  # CHANGE THIS to your battery level sensor
            name: Battery Level
            icon: mdi:battery
          - entity: sensor.inverter_export_power  # CHANGE THIS to your export power sensor
            name: Grid Export
            icon: mdi:transmission-tower-export
        state_color: true

      # === LIVE CALCULATION ===
      - type: markdown
        title: ðŸ§® Live Calculation Debug
        content: >-
          **Current Time:** {{ now().strftime('%H:%M:%S') }}
          
          **Grid Price:** {{ states('sensor.amber_general_price') | float(0) | round(2) }}c/kWh
          
          **House Load:** {{ states('sensor.inverter_load_power') | int(0) }}W
          
          **Target Generation:**
          {{ states('sensor.inverter_load_power') | int(0) + 4500 + 500 }}W
          (House + Battery + Buffer)
          
          **Fronius Limit:** 
          {% set house = states('sensor.inverter_load_power') | int(0) %}
          {% set target = house + 4500 + 500 %}
          {% set limit = [target, 8200] | min %}
          {{ limit }}W (capped at inverter max)
          
          **Curtailment Allowed:** 
          {% if now().hour < 16 and is_state('input_boolean.fronius_manual_override', 'off') %}
          âœ… YES (before 4pm, no override)
          {% else %}
          âŒ NO (after 4pm or override active)
          {% endif %}
          
          **Status:** 
          {% if states('sensor.amber_general_price') | float(0) < 0 %}
          ðŸ”´ NEGATIVE PRICING - Curtailment should be active
          {% else %}
          ðŸŸ¢ POSITIVE PRICING - Full generation allowed
          {% endif %}
        card_mod:
          style: |
            ha-card {
              background: var(--ha-card-background, var(--card-background-color, white));
              font-family: monospace;
            }

      # === AUTOMATION STATUS ===
      - type: entities
        title: ðŸ¤– Automation Status
        entities:
          - entity: automation.fronius_solar_curtailment_main  # CHANGE THIS to your blueprint automation name
            name: Main Curtailment Logic
            secondary_info: last-triggered
          - entity: automation.fronius_curtailment_auto_restore
            name: 4pm Auto-Restore
            secondary_info: last-triggered
          - entity: automation.fronius_manual_override_handler
            name: Manual Override Handler
            secondary_info: last-triggered
          - entity: automation.fronius_manual_override_auto_reset
            name: 6am Override Reset
            secondary_info: last-triggered
        state_color: true

      # === 24 HOUR HISTORY ===
      - type: history-graph
        title: ðŸ“ˆ 24 Hour Power Flow
        hours_to_show: 24
        refresh_interval: 60
        entities:
          - entity: sensor.amber_general_price  # CHANGE THIS
            name: Grid Price
          - entity: sensor.inverter_pv_power  # CHANGE THIS
            name: Solar Gen
          - entity: sensor.inverter_load_power  # CHANGE THIS
            name: House Load
          - entity: sensor.inverter_export_power  # CHANGE THIS
            name: Export
          - entity: input_boolean.solar_curtailment_active
            name: Curtailment

      # === ENERGY DASHBOARD LINK ===
      - type: button
        name: Open Energy Dashboard
        icon: mdi:lightning-bolt
        tap_action:
          action: navigate
          navigation_path: /energy
        show_name: true
        show_icon: true

      # === DAILY STATISTICS ===
      - type: entities
        title: ðŸ“Š Today's Summary
        entities:
          - entity: sensor.daily_solar_generation  # CHANGE THIS to your daily solar sensor
            name: Solar Generated
            icon: mdi:solar-power
          - entity: sensor.daily_grid_export  # CHANGE THIS
            name: Exported to Grid
            icon: mdi:transmission-tower-export
          - entity: sensor.daily_grid_import  # CHANGE THIS
            name: Imported from Grid
            icon: mdi:transmission-tower-import
          - entity: sensor.daily_battery_charge  # CHANGE THIS
            name: Battery Charged
            icon: mdi:battery-charging
          - entity: sensor.daily_house_consumption  # CHANGE THIS
            name: House Consumed
            icon: mdi:home-lightning-bolt

      # === CURTAILMENT LOG ===
      - type: logbook
        title: ðŸ—’ï¸ Recent Curtailment Events
        hours_to_show: 24
        entities:
          - automation.fronius_solar_curtailment_main  # CHANGE THIS
          - input_boolean.solar_curtailment_active
          - input_boolean.fronius_manual_override

# ============================================================================
# CUSTOMIZATION INSTRUCTIONS
# ============================================================================
# 
# 1. Search for "# CHANGE THIS" comments throughout this file
# 2. Replace placeholder entity IDs with your actual sensors:
#    - sensor.amber_general_price â†’ your Amber price sensor
#    - sensor.inverter_pv_power â†’ your solar generation sensor
#    - sensor.inverter_load_power â†’ your house load sensor
#    - sensor.inverter_battery_level â†’ your battery SOC sensor
#    - sensor.inverter_export_power â†’ your grid export sensor
#    - automation names â†’ your actual automation entity IDs
# 
# 3. Adjust the "Live Calculation Debug" card:
#    - Change 4500 to your battery_charge_target
#    - Change 500 to your safety_buffer
#    - Change 8200 to your inverter_max_output
#    - Change 16 to your curtailment_end_time hour
# 
# 4. Optional: Remove cards you don't need (Daily Statistics, etc.)
# 
# 5. To add this dashboard:
#    Method A (New Dashboard):
#      - Settings > Dashboards > Add Dashboard
#      - Choose "New dashboard from scratch"
#      - Click three dots > Edit Dashboard > Raw configuration editor
#      - Paste this entire YAML
#    
#    Method B (New View in Existing Dashboard):
#      - Open your dashboard
#      - Edit Dashboard > Add View
#      - Switch to YAML mode
#      - Paste the "views:" section
# 
# ============================================================================
